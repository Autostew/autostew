{% extends "autostew_web_home/base.html" %}
{% load extra_filters %}

{% block content %}
    <div class="row">
        <div class="col-xs-12 col-md-4 placeholder">
            <h3>
                Race
                {% if session.finished %}<span class="label label-success">finished</span>
                {% elif session.running %}<span class="label label-danger">in progress</span>
                {% elif session.planned %}<span class="label label-info">planned</span>
                {% endif %}
            </h3>

            <h4>
                <a href="{{ session.setup_actual.get_absolute_url }}">
                    {{ session.setup_actual.name }}
                </a>
            </h4>

            <h4>
                {{ session.setup_actual.track.name }}
                <small><a href="{{ session.setup_actual.get_track_url }}" class="btn btn-default">
                    Leaderboard
                </a></small>
            </h4>

            <h4>{% if session.setup_actual.force_identical_vehicles %}
                {{ session.setup_actual.vehicle.name }}
            {% elif session.setup_actual.force_same_vehicle_class %}
                {{ session.setup_actual.vehicle_class.name }}
            {% else %}
                No vehicle restriction
            {% endif %}</h4>

            <p>
                Real time: {{ session.timestamp|date }} {{ session.timestamp|time }}<br>
                In-game time (x{{ session.setup_actual.date_progression }}):
                {{ session.current_year }}-{{ session.current_month }}-{{ session.current_day }}
                {{ session.current_hour }}:{{ session.current_minute }}
            </p>

            <p>
                {% if session.setup_actual.weather_slots == 0 %}Real weather{% endif %}
                <span style="font-size: xx-large">
                    {% if session.setup_actual.weather_slots > 0 %}{{ session.setup_actual.weather_1.get_icon_or_name|safe }}{% endif %}
                    {% if session.setup_actual.weather_slots > 1 %}{{ session.setup_actual.weather_2.get_icon_or_name|safe }}{% endif %}
                    {% if session.setup_actual.weather_slots > 2 %}{{ session.setup_actual.weather_3.get_icon_or_name|safe }}{% endif %}
                    {% if session.setup_actual.weather_slots > 3 %}{{ session.setup_actual.weather_4.get_icon_or_name|safe }}{% endif %}
                </span>
                (x{{ session.setup_actual.weather_progression }})
            </p>
            <p>
                <i class="wi wi-thermometer" title="Ambient temperature"></i> {{ session.temperature_ambient|temp }} ºC |
                <span class="glyphicon glyphicon-road" title="Track temperature"></span> {{ session.temperature_track|temp }} ºC |
                <i class="wi wi-barometer" title="Air pressure"></i> {{ session.air_pressure|pressure }} hPa
                <br>
                Track wetness: {{ session.wetness_avg|percent }}%
            </p>
        </div>
        <div class="col-xs-12 col-md-4 placeholder" style="text-align: center">
            <h2>
                {% if session.session_state.name == 'Race' %}
                    {{ session.session_stage.name|upper }}
                {% else %}
                    {{ session.session_state.name|upper }}
                {% endif %}
            </h2>
            {% if session.setup_actual.practice1_length %}{{ session.setup_actual.practice1_length }} minutes practice<br>{% endif %}
            {% if session.setup_actual.practice2_length %}{{ session.setup_actual.practice2_length }} minutes practice<br>{% endif %}
            {% if session.setup_actual.qualify_length %}{{ session.setup_actual.qualify_length }} minutes qualifying<br>{% endif %}
            {% if session.setup_actual.warmup_length %}{{ session.setup_actual.warmup_length }} minutes warmup<br>{% endif %}
            <b>{{ session.setup_actual.race1_length }} {% if session.setup_actual.timed_race %}minutes{% else %}laps{% endif %} race</b><br>
            {% if session.setup_actual.enforced_pitstop %}Mandatory pitstop{% endif %}

            <h3>
                {% if session.previous_in_session %}
                    <a class="btn btn-default" href="{% url 'session:snapshot' session.previous_in_session.id %}">
                        <span class="glyphicon glyphicon-triangle-left" aria-hidden="true"></span>
                    </a>
                {% else %}
                    <a class="btn btn-default disabled" href="#">
                        <span class="glyphicon glyphicon-triangle-left" aria-hidden="true"></span>
                    </a>
                {% endif %}
                Navigate
                {% if session.next_in_session %}
                    <a class="btn btn-default" href="{% url 'session:snapshot' session.next_in_session.id %}">
                        <span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>
                    </a>
                {% else %}
                    <a class="btn btn-default disabled" href="#">
                        <span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>
                    </a>
                {% endif %}
            </h3>
            <p>
                {% for stage in session.stages.all %}
                    <a class="btn
                        {% if session.result_of and session.result_of.session_stage == stage.stage %}
                            btn-primary
                        {% elif session.session_stage == stage.stage and session == session.current_snapshot %}
                            btn-danger
                        {% elif session.session_stage == stage.stage %}
                            btn-info
                        {% else %}
                            btn-default
                        {% endif %}
                    " href="{{ stage.get_absolute_url }}">{{ stage.stage.name }}</a>
                {% endfor %}
            </p>

            <p>
                {% if session.parent %}
                    {% include 'autostew_web_session/session_detail_lap_selector.html' with session=session.parent %}
                {% else %}
                    {% include 'autostew_web_session/session_detail_lap_selector.html' with session=session %}
                {% endif %}
                <a class="btn btn-{% if session.parent %}default{% else %}primary{% endif %}"
                   href="{% if session.parent %}{% url 'session:session' session.parent_id %}{% else %}#{% endif %}">
                    Latest
                </a>
            </p>
        </div>
        <div class="col-xs-12 col-md-4 placeholder" style="text-align: center">
            <h3>Aids</h3>
            {% if not session.setup_actual.allow_custom_vehicle_setup %}<p>Default setup only</p>{% endif %}
            Driving aids:
            {% if session.setup_actual.force_realistic_driving_aids %}
                REALISTIC
            {% else %}
                Aids:
                {% if session.setup_actual.abs_allowed %}ABS{% endif %}
                {% if session.setup_actual.sc_allowed %}SC{% endif %}
                {% if session.setup_actual.tcs_allowed %}TCS{% endif %}
            {% endif %}
            {% if session.setup_actual.force_manual %}manual{% else %}automatic{% endif %}
            {% if session.setup_actual.mechanical_failures %}failures{% else %}no-failures{% endif %}
            {% if session.setup_actual.auto_start_engine %}autoenginestart{% else %}manualenginestart{% endif %}
            {% if session.setup_actual.ghost_griefers %}ghostgriefers{% else %}noghost{% endif %}
            <h3>Settings</h3>
            {% if session.setup_actual.rolling_starts %}Rolling start<br>{% endif %}
            {{ session.setup_actual.damage.name|title }} damage<br>
            {{ session.setup_actual.tire_wear.name|title }} tire wear<br>
            {{ session.setup_actual.fuel_usage.name|title }} fuel usage<br>
            {{ session.setup_actual.penalties.name|title }} penalties<br>
            {{ session.setup_actual.allowed_views.name|title }} view
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-condensed">
            <thead>
                <tr>
                    <th></th>
                    <th>Name</th>
                    <th>Lap</th>
                    <th>Last lap</th>
                    <th>Best lap</th>
                    <th>Gap</th>
                    <th>Status</th>
                </tr>
            </thead>
            {% for participant in session.participant_set.all %}
                <tr>
                    <td>
                        <div style="font-size: 220%; float: left; clear: left; padding-right: 15px">
                            P{{ participant.race_position }}
                            <a href="{{ participant.get_absolute_url }}">
                                <span class="glyphicon glyphicon-list-alt" aria-hidden="true" title="To race results"></span>
                            </a>
                            {% if not participant.is_ai %}
                                <a href="{{ participant.member.steam_user.get_absolute_url }}">
                                    <span class="glyphicon glyphicon-user" aria-hidden="true" title="To profile"></span>
                                </a>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <b>{{ participant.name }}</b>
                        <br>
                        {% if participant.is_ai %}
                            <span class="label label-default">
                                <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
                                {{ session.setup_actual.opponent_difficulty }}
                            </span>
                        {% else %}
                            {% if participant.member.steam_user.safety_class %}
                                <span class="label label-default">{{ participant.member.steam_user.safety_class }}</span>
                            {% endif %}
                            {% if participant.member.steam_user.elo_rating %}
                                <span class="label label-default">{{ participant.member.steam_user.elo_rating }}</span>
                            {% endif %}
                        {% endif %}
                        &nbsp;
                        {{ participant.vehicle.name }}
                    </td>
                    <td>
                        {{ participant.current_lap }}
                    </td>
                    <td>
                        {% if participant.last_lap_time %}

                            <span class="
                                {% if participant.last_lap_is_fastest_in_race %}
                                    label label-primary
                                {% elif participant.last_lap_is_fastest_in_shapshot %}
                                    label label-info
                                {% endif %}
                            ">{{ participant.last_lap_time|milli_to_nicetime }}</span>
                        {% else %}
                            ---
                        {% endif %}
                    </td>
                    <td>
                        {% if participant.fastest_lap_time %}
                            <span class="
                                {% if participant.fastest_lap_is_fastest_in_race %}
                                    label label-primary
                                {% endif %}
                            ">{{ participant.fastest_lap_time|milli_to_nicetime }}</span>
                        {% else %}
                            ---
                        {% endif %}
                    </td>
                    <td>
                        {{ participant.gap|milli_to_nicetime }}
                    </td>
                    <td>
                        <span class="
                            {% if participant.state.in_race %}
                                label label-primary
                            {% else %}
                                label label-danger
                            {% endif %}
                        ">{{ participant.state.name }}</span>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <p>
        <a href="{% url 'session:events' session.id %}">Events</a><br>
        <a href="{{ session.server.get_absolute_url }}">{{ session.server }}</a>
    </p>
{% endblock %}
