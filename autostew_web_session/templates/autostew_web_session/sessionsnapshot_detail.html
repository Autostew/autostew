{% extends "autostew_web_home/base.html" %}
{% load extra_filters %}

{% block content %}
    <div class="row">
        <div class="col-xs-12 col-sm-4 placeholder">
            <h3>
                Race
                {% if session.planned %}(planned){% endif %}
                {% if session.running %}in progress{% endif %}
            </h3>
            <h4>{% if session.setup_actual.force_identical_vehicles %}
                {{ session.setup_actual.vehicle.name }}
            {% elif session.setup_actual.force_same_vehicle_class %}
                {{ session.setup_actual.vehicle_class.name }}
            {% else %}
                No vehicle restriction
            {% endif %}</h4>

            <h4>
                {{ session.setup_actual.name }}
                {% if session.setup_actual.server_controls_setup %}(server setup){% else %}(client setup){% endif %}
            </h4>

            Real time: {{ sessionsnapshot.timestamp|date }} {{ sessionsnapshot.timestamp|time }}<br>
            In-game time (x{{ session.setup_actual.date_progression }}):
            {{ sessionsnapshot.current_year }}-{{ sessionsnapshot.current_month }}-{{ sessionsnapshot.current_day }}
            {{ sessionsnapshot.current_hour }}:{{ sessionsnapshot.current_minute }}
        </div>
        <div class="col-xs-12 col-sm-4 placeholder" style="text-align: center">
            <h2>{{ sessionsnapshot.session_stage.name|upper }}</h2>
            {% if session.setup_actual.practice1_length %}{{ session.setup_actual.practice1_length }} minutes practice<br>{% endif %}
            {% if session.setup_actual.practice2_length %}{{ session.setup_actual.practice2_length }} minutes practice<br>{% endif %}
            {% if session.setup_actual.qualify_length %}{{ session.setup_actual.qualify_length }} minutes qualifying<br>{% endif %}
            {% if session.setup_actual.warmup_length %}{{ session.setup_actual.warmup_length }} minutes warmup<br>{% endif %}
            <b>{{ session.setup_actual.race1_length }} {% if session.setup_actual.timed_race %}minutes{% else %}laps{% endif %} race</b><br>
            {% if session.setup_actual.enforced_pitstop %}Mandatory pitstop{% endif %}
        </div>
        <div class="col-xs-12 col-sm-4 placeholder" style="text-align: center">
            <h3>
                {% if sessionsnapshot.previous_in_session %}
                    <a class="btn btn-default" href="{% url 'session:snapshot' sessionsnapshot.previous_in_session.id %}">
                        <span class="glyphicon glyphicon-triangle-left" aria-hidden="true"></span>
                    </a>
                {% else %}
                    <a class="btn btn-default disabled" href="#">
                        <span class="glyphicon glyphicon-triangle-left" aria-hidden="true"></span>
                    </a>
                {% endif %}
                Navigate
                {% if sessionsnapshot.next_in_session %}
                    <a class="btn btn-default" href="{% url 'session:snapshot' sessionsnapshot.next_in_session.id %}">
                        <span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>
                    </a>
                {% else %}
                    <a class="btn btn-default disabled" href="#">
                        <span class="glyphicon glyphicon-triangle-right" aria-hidden="true"></span>
                    </a>
                {% endif %}
            </h3>
            <p>
                {% for stage in session.stages.all %}
                    <a class="btn
                        {% if sessionsnapshot.result_of and sessionsnapshot.result_of.session_stage == stage.stage %}
                            btn-primary
                        {% elif sessionsnapshot.session_stage == stage.stage and sessionsnapshot == session.current_snapshot %}
                            btn-danger
                        {% elif sessionsnapshot.session_stage == stage.stage %}
                            btn-info
                        {% else %}
                            btn-default
                        {% endif %}
                    " href="{{ stage.get_absolute_url }}">{{ stage.stage.name }}</a>
                {% endfor %}
            </p>

            <p>
                <div class="btn-group">
                  <button type="button" class="btn btn-default">Lap {{ sessionsnapshot.racelapsnapshot_set.first.lap|add:1 }}</button>
                  <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <span class="caret"></span>
                    <span class="sr-only">Toggle Dropdown</span>
                  </button>
                  <ul class="dropdown-menu">
                    {% for lap in session.racelapsnapshot_set.all %}
                        <li><a href="{{ lap.get_absolute_url }}">{{ lap.lap|add:1 }}</a></li>
                    {% endfor %}
                  </ul>
                </div>
                <a class="btn btn-{% if sessionsnapshot == session.current_snapshot %}primary{% else %}default{% endif %}"
                   href="{% url 'session:session' session.id %}">
                    Latest
                </a>
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12 col-sm-4 placeholder">
            <h3>
                <a href="{{ session.setup_actual.track.get_absolute_url }}">
                    {{ session.setup_actual.track.name }}
                </a>
            </h3>
            Weather (x{{ session.setup_actual.weather_progression }}):
            {% if session.setup_actual.weather_slots > 0 %}{{ session.setup_actual.weather_1.name }}{% endif %}
            {% if session.setup_actual.weather_slots > 1 %}{{ session.setup_actual.weather_2.name }}{% endif %}
            {% if session.setup_actual.weather_slots > 2 %}{{ session.setup_actual.weather_3.name }}{% endif %}
            {% if session.setup_actual.weather_slots > 3 %}{{ session.setup_actual.weather_4.name }}{% endif %}
            <br>
            {{ sessionsnapshot.temperature_ambient|temp }} ºC |
            {{ sessionsnapshot.temperature_track|temp }} ºC |
            {{ sessionsnapshot.air_pressure|pressure }} hPa
            <br>
            Wetness: {{ sessionsnapshot.wetness_avg|percent }}%
        </div>
        <div class="col-xs-12 col-sm-4 placeholder">
            <h3>Aids</h3>
            {% if not session.setup_actual.allow_custom_vehicle_setup %}<p>Default setup only</p>{% endif %}
            Driving aids:
            {% if session.setup_actual.force_realistic_driving_aids %}
                REALISTIC
            {% else %}
                Aids:
                {% if session.setup_actual.abs_allowed %}ABS{% endif %}
                {% if session.setup_actual.sc_allowed %}SC{% endif %}
                {% if session.setup_actual.tcs_allowed %}TCS{% endif %}
            {% endif %}
            {% if session.setup_actual.force_manual %}manual{% else %}automatic{% endif %}
            {% if session.setup_actual.mechanical_failures %}failures{% else %}no-failures{% endif %}
            {% if session.setup_actual.auto_start_engine %}autoenginestart{% else %}manualenginestart{% endif %}
            {% if session.setup_actual.ghost_griefers %}ghostgriefers{% else %}noghost{% endif %}
        </div>
        <div class="col-xs-12 col-sm-4 placeholder">
            <h3></h3>
            {% if session.setup_actual.rolling_starts %}Rolling start<br>{% endif %}
            {{ session.setup_actual.damage.name|title }} damage<br>
            {{ session.setup_actual.tire_wear.name|title }} tire wear<br>
            {{ session.setup_actual.fuel_usage.name|title }} fuel usage<br>
            {{ session.setup_actual.penalties.name|title }} penalties<br>
            {{ session.setup_actual.allowed_views.name|title }} view
        </div>
    </div>
    <hr>
    <div class="table-responsive">
        <table class="table table-striped table-hover table-condensed">
            <thead>
                <td></td>
                <td>Name</td>
                <td></td>
                <td>Lap</td>
                <td>Last lap</td>
                <td>Best lap</td>
                <td>Gap</td>
                <td>Status</td>
            </thead>
            {% for participant in sessionsnapshot.participantsnapshot_set.all %}
                <tr>
                    <td>
                        <div style="font-size: 220%; float: left; clear: left; padding-right: 15px">
                            P{{ participant.race_position }}
                        </div>
                    </td>
                    <td>
                        <b>{{ participant.participant.name }}</b>
                        <br>
                        {% if participant.participant.is_ai %}
                            <span class="label label-default">
                                <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>{{ session.setup_actual.opponent_difficulty }}
                            </span>
                        {% endif %}
                        &nbsp;
                        {{ participant.participant.vehicle.name }}
                    </td>
                    <td>
                        <a href="{{ participant.participant.get_absolute_url }}">
                            <span class="glyphicon glyphicon-list" aria-hidden="true"></span>
                        </a>
                        {% if not participant.participant.is_ai %}
                            <a href="{{ participant.participant.member.steam_user.get_absolute_url }}">
                                <span class="glyphicon glyphicon-user" aria-hidden="true"></span>
                            </a>
                        {% endif %}
                    </td>
                    <td>
                        {{ participant.current_lap }}
                    </td>
                    <td>
                        {% if participant.last_lap_time %}

                            <span class="
                                {% if participant.last_lap_is_fastest_in_race %}
                                    label label-primary
                                {% elif participant.last_lap_is_fastest_in_shapshot %}
                                    label label-info
                                {% endif %}
                            ">{{ participant.last_lap_time|milli_to_nicetime }}</span>
                        {% else %}
                            ---
                        {% endif %}
                    </td>
                    <td>
                        {% if participant.fastest_lap_time %}
                            <span class="
                                {% if participant.fastest_lap_is_fastest_in_race %}
                                    label label-primary
                                {% endif %}
                            ">{{ participant.fastest_lap_time|milli_to_nicetime }}</span>
                        {% else %}
                            ---
                        {% endif %}
                    </td>
                    <td>
                        {{ participant.gap|milli_to_nicetime }}
                    </td>
                    <td>
                        <span class="
                            {% if participant.state.in_race %}
                                label label-primary
                            {% else %}
                                label label-danger
                            {% endif %}
                        ">{{ participant.state.name }}</span>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <p>
        <a href="{% url 'session:events' session.id %}">Events</a><br>
        <a href="{{ session.server.get_absolute_url }}">{{ session.server }}</a>
    </p>
{% endblock %}
