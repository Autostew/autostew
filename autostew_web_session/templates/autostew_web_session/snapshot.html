{% extends "autostew_web_session/base.html" %}
{% load extra_filters %}

{% block content %}
    <div class="row">
        <div class="col-xs-4 col-sm-4 placeholder">
            <h3>
                Race
                {% if session.planned %}(planned){% endif %}
                {% if session.running %}in progress{% endif %}
            </h3>
            <h4>{% if session.setup.force_identical_vehicles %}
                {{ session.setup.vehicle.name }}
            {% elif session.setup.force_same_vehicle_class %}
                {{ session.setup.vehicle_class.name }}
            {% else %}
                No vehicle restriction
            {% endif %}</h4>

            {% if session.setup.server_controls_setup %}Server-controlled{% else %}Player-controlled{% endif %}<br>
            Snapshot at {{ sessionsnapshot.timestamp|date }} {{ sessionsnapshot.timestamp|time }}<br>


            In-game race start time:
            {{ session.setup.date_year }}-{{ session.setup.date_month }}-{{ session.setup.date_day }}
            {{ session.setup.date_hour }}:{{ session.setup.date_minute }} (x{{ session.setup.date_progression }})<br>
            In-game current time:
            {{ sessionsnapshot.current_year }}-{{ sessionsnapshot.current_month }}-{{ sessionsnapshot.current_day }}
            {{ sessionsnapshot.current_hour }}:{{ sessionsnapshot.current_minute }}
        </div>
        <div class="col-xs-4 col-sm-4 placeholder">
            <h2>{{ sessionsnapshot.session_stage.name|upper }}</h2>
            {% if session.setup.practice1_length %}{{ session.setup.practice1_length }} minutes practice<br>{% endif %}
            {% if session.setup.practice2_length %}{{ session.setup.practice2_length }} minutes practice<br>{% endif %}
            {% if session.setup.qualify_length %}{{ session.setup.qualify_length }} minutes qualifying<br>{% endif %}
            {% if session.setup.warmup_length %}{{ session.setup.warmup_length }} minutes warmup<br>{% endif %}
            <b>{{ session.setup.race1_length }} {% if session.setup.timed_race %}minutes{% else %}laps{% endif %} race</b><br>
            {% if session.setup.enforced_pitstop %}Mandatory pitstop{% endif %}
        </div>
        <div class="col-xs-4 col-sm-4 placeholder">
            <h4></h4>
            {% for snapshot in session.sessionsnapshot_set.all %}
                <a href="{% url 'session:snapshot' snapshot.id %}">{{ snapshot.id }}</a> --
            {% endfor %}
            <br>
            Go to lap:
            {% for lap in session.racelapsnapshot_set.all %}
                <a href="{% url 'session:snapshot' lap.snapshot.id %}">{{ lap.lap }}</a> --
            {% endfor %}
            <br>
            {% if session.current_snapshot %}
                <a href="{% url 'session:snapshot' session.current_snapshot.id %}">Latest</a><br>
            {% endif %}
            {% if session.first_snapshot %}
                <a href="{% url 'session:snapshot' session.first_snapshot.id %}">First</a><br>
            {% endif %}
            {% if session.ending_snapshot_race %}
                <a href="{% url 'session:snapshot' session.ending_snapshot_race.id %}">Race end</a><br>
            {% endif %}
            {% if session.starting_snapshot_race %}
                <a href="{% url 'session:snapshot' session.starting_snapshot_race.id %}">Race start</a><br>
            {% endif %}
            {% if session.starting_snapshot_practice1 %}
                <a href="{% url 'session:snapshot' session.starting_snapshot_practice1.id %}">Practice start</a><br>
            {% endif %}
            {% if session.starting_snapshot_practice2 %}
                <a href="{% url 'session:snapshot' session.starting_snapshot_practice2.id %}">Practice 2 start</a><br>
            {% endif %}
            {% if session.starting_snapshot_qualifying %}
                <a href="{% url 'session:snapshot' session.starting_snapshot_qualifying.id %}">Qualifying start</a><br>
            {% endif %}
            {% if session.starting_snapshot_lobby %}
                <a href="{% url 'session:snapshot' session.starting_snapshot_qualifying.id %}">Lobby start</a><br>
            {% endif %}
            {% if session.starting_snapshot_warmup %}
                <a href="{% url 'session:snapshot' session.starting_snapshot_warmup.id %}">Lobby start</a><br>
            {% endif %}
            {% if session.starting_snapshot_to_track %}
                <a href="{% url 'session:snapshot' session.starting_snapshot_to_track.id %}">Day start</a><br>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-xs-4 col-sm-4 placeholder">
            <h3>{{sessionsnapshot.session.setup.track.name}}</h3>
            Weather (x{{ session.setup.weather_progression }}):
            {% if session.setup.weather_slots > 0 %}{{ session.setup.weather_1.name }}{% endif %}
            {% if session.setup.weather_slots > 1 %}{{ session.setup.weather_2.name }}{% endif %}
            {% if session.setup.weather_slots > 2 %}{{ session.setup.weather_3.name }}{% endif %}
            {% if session.setup.weather_slots > 3 %}{{ session.setup.weather_4.name }}{% endif %}
            <br>
            Ambient: {{ sessionsnapshot.temperature_ambient|temp }}ºC {{ sessionsnapshot.air_pressure|pressure }}hPa<br>
            Track: {{ sessionsnapshot.temperature_track|temp }}ºC<br>
            Wetness: {{ sessionsnapshot.wetness_avg|percent }}%
        </div>
        <div class="col-xs-4 col-sm-4 placeholder">
            <h3>Aids</h3>
            {% if not session.setup.allow_custom_vehicle_setup %}<p>Default setup only</p>{% endif %}
            Driving aids:
            {% if session.setup.force_realistic_driving_aids %}
                REALISTIC
            {% else %}
                Aids:
                {% if session.setup.abs_allowed %}ABS{% endif %}
                {% if session.setup.sc_allowed %}SC{% endif %}
                {% if session.setup.tcs_allowed %}TCS{% endif %}
            {% endif %}
            {% if session.setup.force_manual %}manual{% else %}automatic{% endif %}
            {% if session.setup.mechanical_failures %}failures{% else %}no-failures{% endif %}
            {% if session.setup.auto_start_engine %}autoenginestart{% else %}manualenginestart{% endif %}
            {% if session.setup.ghost_griefers %}ghostgriefers{% else %}noghost{% endif %}
        </div>
        <div class="col-xs-4 col-sm-4 placeholder">
            <h3></h3>
            {% if session.setup.rolling_starts %}Rolling start<br>{% endif %}
            {{ session.setup.damage.name|title }} damage<br>
            {{ session.setup.tire_wear.name|title }} tire wear<br>
            {{ session.setup.fuel_usage.name|title }} fuel usage<br>
            {{ session.setup.penalties.name|title }} penalties<br>
            {{ session.setup.allowed_views.name|title }} view
        </div>
    </div>
    <hr>
    <div class="table-responsive">
        <table class="table table-striped table-hover table-condensed">
            <thead>
                <td>Name</td>
                <td>Lap</td>
                <td>Last lap</td>
                <td>Best lap</td>
                <td>Gap</td>
                <td>Status</td>
            </thead>
            {% for participant in sessionsnapshot.participantsnapshot_set.all %}
                <tr>
                    <td>
                        <div style="font-size: 220%; float: left; clear: left; padding-right: 15px">
                            P{{ participant.race_position }}
                        </div>
                        <b>{{ participant.participant.name }}</b>
                        {% if participant.participant.is_ai %}<b>(AI{{ session.setup.opponent_difficulty }})</b>{% endif %}
                        <br>
                        {{ participant.participant.vehicle.name }}
                    </td>
                    <td>
                        {{ participant.current_lap }}
                    </td>
                    <td>
                        {% if participant.last_lap_time %}
                            {{ participant.last_lap_time|milli_to_nicetime }}
                        {% else %}
                            ---
                        {% endif %}
                    </td>
                    <td>
                        {% if participant.fastest_lap_time %}
                            {{ participant.fastest_lap_time|milli_to_nicetime }}
                        {% else %}
                            ---
                        {% endif %}
                    </td>
                    <td>
                        {{ participant.gap|milli_to_nicetime }}
                    </td>
                    <td>
                        {{ participant.state.name }}
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
{% endblock %}
